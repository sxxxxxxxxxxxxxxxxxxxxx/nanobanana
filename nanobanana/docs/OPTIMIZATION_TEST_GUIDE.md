# 🧪 性能优化测试指南

## 🎯 测试目标

验证性能优化是否成功：
1. ✅ 图片处理速度是否显著提升
2. ✅ AI生成的图片分辨率是否与原图一致
3. ✅ 下载速度是否加快
4. ✅ 是否消除了重复处理

## 📋 测试步骤

### 步骤 1：启动服务器
```bash
cd nanobanana
deno run --allow-net --allow-read --allow-env main.ts
```
服务器将运行在：`http://localhost:3000`

### 步骤 2：打开浏览器控制台
1. 访问 `http://localhost:3000`
2. 按 `F12` 打开开发者工具
3. 切换到 **Console（控制台）** 标签页

### 步骤 3：准备测试图片
- 建议使用：1440×1800 或类似高分辨率图片
- 可以使用项目自带的 `static/xiguadepi.jpg`

### 步骤 4：执行测试

#### 测试 A：图片生成和显示
1. 上传一张图片
2. 输入API Key
3. 输入修图指令（如："增强对比度"）
4. 点击 **"开始修图"**
5. 观察控制台日志

**预期结果**：
```javascript
⚡ [性能优化] fastResizeImage 开始: 目标尺寸 1440x1800
⏱️ [性能] 图片加载耗时: 245.23ms
🖼️ 当前尺寸: 896x1152 -> 目标: 1440x1800
⏱️ [性能] Canvas处理耗时: 156.78ms
⏱️ [性能] 转换耗时: 89.45ms
✅ [性能优化] 总耗时: 491.46ms (1440x1800)
✅ [性能优化] 前端resize完成，图片已缓存
```

**关键指标**：
- ✅ 总处理时间 < 1秒
- ✅ 显示 "图片已缓存" 字样
- ✅ 输出尺寸与原图一致

#### 测试 B：下载速度
1. 完成测试A后，点击 **"下载图片"** 按钮
2. 观察控制台日志

**预期结果**：
```javascript
🎯 [性能优化] 下载按钮被点击
⚡ [性能优化] 使用缓存的已调整图片，跳过重复resize（性能提升100%）
✅ [性能优化] 下载已调整的图片 (1440x1800)
```

**关键指标**：
- ✅ **不会看到第二次resize日志**（说明使用了缓存）
- ✅ 下载几乎瞬间完成（<0.2秒）
- ✅ 下载的图片分辨率与原图一致

## 📊 性能对比表

填写您的测试结果：

| 测试项目 | 优化前（预估） | 优化后（实际） | 改善 |
|---------|---------------|---------------|------|
| 显示图片耗时 | 3-5秒 | _____秒 | ___% |
| 下载图片耗时 | 2-3秒 | _____秒 | ___% |
| resize次数 | 2次 | _____次 | ___% |
| 网络请求次数 | 3次 | _____次 | ___% |

## ✅ 验证清单

### 功能验证
- [ ] AI生成的图片能正常显示
- [ ] 图片分辨率自动调整为原始尺寸
- [ ] 下载功能正常工作
- [ ] 下载的图片分辨率正确

### 性能验证
- [ ] 控制台显示性能优化日志
- [ ] 显示图片耗时 < 1秒
- [ ] 下载图片显示"使用缓存"
- [ ] 下载时无第二次resize日志
- [ ] 总处理时间显著减少

### 质量验证
- [ ] 输出图片清晰，无明显失真
- [ ] 图片尺寸信息准确显示
- [ ] 历史记录功能正常

## 🐛 常见问题排查

### 问题 1：看不到性能日志
**原因**：浏览器控制台被清空  
**解决**：勾选控制台的"Preserve log"选项

### 问题 2：resize仍然执行2次
**原因**：代码未正确更新  
**解决**：
1. 硬刷新浏览器：`Ctrl + F5`
2. 检查 `script.js` 是否更新
3. 重启Deno服务器

### 问题 3：图片分辨率不一致
**原因**：原始尺寸未正确获取  
**解决**：
1. 查看 "图片尺寸信息" 显示的原始尺寸
2. 确保上传图片后等待尺寸信息显示

## 📈 性能基准参考

### 不同分辨率的预期处理时间

| 分辨率 | 预期耗时 | 说明 |
|--------|---------|------|
| 512×512 | 50-100ms | 小图片，极快 |
| 1024×1024 | 150-300ms | 中等图片 |
| 1440×1800 | 400-600ms | 大图片 |
| 2048×2048 | 800-1200ms | 超大图片 |

### Canvas处理性能
- 图片加载：200-300ms
- Canvas绘制：100-200ms
- 格式转换：50-100ms
- **总计**：350-600ms（1440×1800）

## 🎉 成功标准

如果您的测试结果满足以下条件，则优化成功：

1. ✅ **速度提升 > 70%**
2. ✅ **下载无需重新resize**
3. ✅ **分辨率100%一致**
4. ✅ **控制台日志清晰可见**
5. ✅ **用户体验流畅**

## 📝 测试报告模板

```
测试日期：____年__月__日
测试环境：Windows/Mac/Linux
浏览器：Chrome/Firefox/Edge ____版本
测试图片：分辨率 ____×____

测试结果：
1. 显示耗时：____ms
2. 下载耗时：____ms
3. resize次数：____次
4. 分辨率一致性：是/否

性能提升：____%
综合评价：优秀/良好/一般

备注：
________________________________
```

## 🚀 下一步

优化成功后，您可以：
1. 将代码推送到GitHub
2. 部署到Deno Deploy
3. 享受极速的AI修图体验！

---
测试愉快！如有问题，请查看 `PERFORMANCE_OPTIMIZATION.md` 了解技术细节。

