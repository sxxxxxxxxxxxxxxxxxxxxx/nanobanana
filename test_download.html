<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>下载功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>下载功能测试</h1>
    
    <div class="test-section">
        <h2>测试 Data URL 下载</h2>
        <button onclick="testDataUrlDownload()">测试 Data URL 下载</button>
        <div id="dataUrlResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>测试 URL 下载</h2>
        <button onclick="testUrlDownload()">测试 URL 下载</button>
        <div id="urlResult" class="result"></div>
    </div>
    
    <div class="test-section">
        <h2>测试 AI 生成图片下载</h2>
        <button onclick="testAIImageDownload()">测试 AI 图片下载</button>
        <div id="aiResult" class="result"></div>
    </div>

    <script>
        // 测试 Data URL 下载
        function testDataUrlDownload() {
            const resultDiv = document.getElementById('dataUrlResult');
            resultDiv.innerHTML = '正在测试 Data URL 下载...';
            
            try {
                // 创建一个简单的测试图片 (1x1 像素的红色图片)
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = 'red';
                ctx.fillRect(0, 0, 100, 100);
                
                const dataUrl = canvas.toDataURL('image/png');
                
                // 使用修复后的下载函数
                downloadResizedImage(dataUrl);
                
                resultDiv.innerHTML = '✅ Data URL 下载测试完成，请检查下载文件夹';
            } catch (error) {
                resultDiv.innerHTML = `❌ Data URL 下载测试失败: ${error.message}`;
            }
        }
        
        // 测试 URL 下载
        function testUrlDownload() {
            const resultDiv = document.getElementById('urlResult');
            resultDiv.innerHTML = '正在测试 URL 下载...';
            
            try {
                // 使用一个公开的测试图片
                const testImageUrl = 'https://picsum.photos/200/200';
                downloadResizedImage(testImageUrl);
                
                resultDiv.innerHTML = '✅ URL 下载测试完成，请检查下载文件夹';
            } catch (error) {
                resultDiv.innerHTML = `❌ URL 下载测试失败: ${error.message}`;
            }
        }
        
        // 测试 AI 生成图片下载
        function testAIImageDownload() {
            const resultDiv = document.getElementById('aiResult');
            resultDiv.innerHTML = '正在测试 AI 图片下载...';
            
            try {
                // 模拟 AI 生成的图片 URL
                const aiImageUrl = 'https://cloudflarer2.nananobanana.com/png/1756965065492_762.png';
                downloadResizedImage(aiImageUrl);
                
                resultDiv.innerHTML = '✅ AI 图片下载测试完成，请检查下载文件夹';
            } catch (error) {
                resultDiv.innerHTML = `❌ AI 图片下载测试失败: ${error.message}`;
            }
        }
        
        // 修复后的下载函数
        function downloadResizedImage(imageUrl, targetWidth = null, targetHeight = null) {
            console.log('开始下载图片:', imageUrl);
            
            // 检查是否是data URL格式
            if (imageUrl.startsWith('data:')) {
                console.log('检测到 Data URL，使用直接下载方式');
                
                // 对于data URL，直接创建下载链接
                const link = document.createElement('a');
                link.href = imageUrl;
                
                // 生成文件名
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                let filename = `test-download-${timestamp}.png`;
                
                if (targetWidth && targetHeight) {
                    filename = `test-download-${targetWidth}x${targetHeight}-${timestamp}.png`;
                }
                
                link.download = filename;
                link.style.display = 'none';
                
                // 添加到DOM，点击，然后清理
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('Data URL 图片下载成功');
                return;
            }
            
            console.log('检测到 URL，使用 fetch 下载方式');
            
            // 对于URL格式，使用fetch下载图片数据，然后创建blob URL进行下载
            fetch(imageUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`图片下载失败: ${response.status} ${response.statusText}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    console.log('图片数据获取成功，创建 blob URL');
                    
                    // 创建blob URL
                    const blobUrl = URL.createObjectURL(blob);
                    
                    // 生成文件名
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
                    let filename = `test-download-${timestamp}.png`;
                    
                    if (targetWidth && targetHeight) {
                        filename = `test-download-${targetWidth}x${targetHeight}-${timestamp}.png`;
                    }
                    
                    // 创建下载链接
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    // 添加到DOM，点击，然后清理
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 清理blob URL
                    setTimeout(() => {
                        URL.revokeObjectURL(blobUrl);
                    }, 1000);
                    
                    console.log('图片下载成功');
                })
                .catch(error => {
                    console.error('图片下载失败:', error);
                    throw error;
                });
        }
    </script>
</body>
</html>
